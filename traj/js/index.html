<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <title>ASC5ENA Trajectory Simulator</title>
  <script src="jquery-1.7.1.min.js" type="application/javascript"></script>
  <script src="local.js" type="application/javascript"></script>
  <style type="text/css">
    .Ainputs { display: none }
    a.Ainputs { margin-right: 5px }
    #logout { font-size: smaller }
    .request { text-align: center }
    #Instructions {
      float: left;
      width: 500px;
      padding: 10px;
      margin-right: 10px;
      background-color: #CCCCCC;
    }
    #Login {
      padding: 10px;
      margin-right: 10px;
      background-color: #CCCCFF;
      float: left;
    }
    #Begin {
      background-color: cyan;
      padding: 4px;
    }
  </style>
  <script>
    function ajax_request(opts, always_func, fail_func) {
      var fail_function;
      if (arguments.length >= 3) {
        fail_function = fail_func;
      }
      $.ajax( ajaxpl, { data: opts, dataType: "json" } )
        .fail(function() {
          alert( "Ajax request failed" );
        })
        .always(function(data, textstatus, jqXHR) {
          if (data.status && typeof(data.status) == 'string') {
            if (data.status.match(/^success/i)) {
              always_func(data);
            } else if (fail_function) {
              fail_function(data);
            } else {
              alert(data.status);
            }
          }
        });
    }
    function initialize() {
      ajax_request({ req: "initialize" }, init_data);
    }
    function init_data(data) {
      if (data.status.match(/^success: logged_in/i)) {
        logged_in(data.fullname);
      } else if (data.status.match(/^success: logged_out/i)) {
        logged_out();
      } else {
        alert('Unknown status from set password: ' + data.status);
      }
    }
    function login_data(data) {
      logged_in(data.user);
    }
    function login_fail_data(data) {
      alert(data.status);
    }
    function logout_data(data) {
      if (data.status.match(/^success: logged_in/i)) {
        alert("Expected logged_out after logout request");
      } else if (data.status.match(/^success: logged_out/i)) {
        logged_out();
      } else {
        alert('Unknown status from set password: ' + data.status);
      }
    }
    function create_data(data) {
      $(".Ainputs").hide();
      $("#status_info").html(
        "<p>A confirmation message has been sent." +
	"Please check your email now in order to complete your registration.</p>");
      $(".wait_confirm").show();
    }

    function logged_in(user) {
      $(".Ainputs").hide();
      $("#cur_username").html(user);
      $(".logged_in").show();
    }
    function logged_out() {
      $(".Ainputs").hide();
      $("#username").val("");
      $("#password").val("");
      $(".logged_out").show();
    }
    function setup_functions() {
      $(".Ainputs").hide();
      $("#status_info").html("Initializing...");
      $(".status_info").show();

      $("#logout").click(function() {
          ajax_request({ req: "logout" }, logout_data);
        });
      $("#login").click(function() {
          ajax_request({
            req: "login",
            username: $("#username").val(),
            password: $("#password").val()
          }, login_data, login_fail_data );
        });
      $("#create_acct").click(function () {
          $(".Ainputs").hide();
          $(".create_acct").show();
          return false;
        });
      $("#existing_user").click(function() {
          $(".Ainputs").hide();
          $(".logged_out").show();
          return false;
        });
      $("#create").click(function() {
          ajax_request({
              req: "create_user",
              username: $("#username").val(),
              fullname: $("#fullname").val(),
              email: $("#email").val()
            }, create_data, login_fail_data);
        });
      $("#guest_acct").click(function() {
          ajax_request({
            req: "login",
            username: "Guest",
            password: "Guest"
          }, login_data, login_fail_data );
          return false;
        });
      $("#forgot_passwd").click(function() {
          $(".Ainputs").hide();
          $(".reset_pw").show();
          return false;
        });
      $("#pwreset").click(function() {
          ajax_request({
              req: "forgot_pw",
              email: $("#email").val()
            }, create_data);
        });
      setTimeout(initialize, 200);
    }
    $(document).ready(function(){ setup_functions(); })
  </script>
</head>
<body>
<h1>ASC5ENA Trajectory Simulator</h1>
<div id="Instructions">
  <h2>Instructions</h2>
  <p>The goal is to pilot your startocruiser from launch
  at Fort Sumner, New Mexico, keeping it within the relatively
  unpopulated central western states for two or more weeks
  and then return to the starting point.</p>
  <p id="#Begin" class="Ainputs logged_in"><a href="traj.html">Begin</a></p>
</div>
<div id="Login">
  <div class="Ainputs status_info wait_confirm" id="status_info"></div>
  <form>
    <table class="Ainputs logged_out logged_in create_acct reset_pw">
      <tr class="Ainputs logged_in">
        <th>user:</th>
        <td><span id="cur_username"></span> <a href="#" id="logout">logout</a></td></tr>
      <tr class="Ainputs create_acct logged_out">
        <th>username:</th>
        <td><input id="username" name="username" type="text"></td></tr>
      <tr class="Ainputs logged_out">
        <th>password:</th>
        <td><input id="password" name="password" type="password"></td></tr>
      <tr class="Ainputs create_acct">
        <th>Full Name:</th>
        <td><input id="fullname" name="fullname" type="text"></td></tr>
      <tr class="Ainputs create_acct reset_pw">
        <th>Email:</th>
        <td><input id="email" name="email" type="text"></td></tr>
      <tr>
        <td colspan="2" class="request">
          <input class="Ainputs logged_out" type="button" id="login" value="Login">
          <input class="Ainputs create_acct" type="button" id="create" value="Create">
          <input class="Ainputs reset_pw" type="button" id="pwreset" value="Send Reset Email">
        </td></tr>
    </table>
    <a class="Ainputs logged_out" id="create_acct" href="#">create a new account</a>
    <a class="Ainputs logged_out" href="#" id="forgot_passwd">forgot password</a>
    <a class="Ainputs create_acct reset_pw wait_confirm" id="existing_user" href="#">login as existing user</a>
    <a class="Ainputs logged_out create_acct reset_pw wait_confirm" id="guest_acct" href="#">run as guest</a>
  </form>
</div>
</body>
</html>
